<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PiX Pay - Super Advanced Dashboard</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icon-192.png">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f4f4f4; transition: background 0.3s; }
    .dark-mode { background: #121212; color: #ffffff; }
    .container { max-width: 1200px; margin: auto; }
    .section { background: white; padding: 20px; margin: 20px 0; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .section:hover { transform: translateY(-2px); }
    .dark-mode .section { background: #1e1e1e; color: #ffffff; }
    button { padding: 12px 18px; background: linear-gradient(45deg, #1da1f2, #0d95e8); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
    button:hover { background: linear-gradient(45deg, #0d95e8, #1da1f2); }
    input, select, textarea { padding: 10px; margin: 5px; width: calc(100% - 20px); max-width: 300px; border: 1px solid #ddd; border-radius: 5px; }
    .dark-mode input, .dark-mode select, .dark-mode textarea { background: #333; color: #fff; border-color: #555; }
    #notifications { position: fixed; top: 10px; right: 10px; width: 320px; background: #e8f5e8; border: 1px solid #4caf50; padding: 15px; border-radius: 8px; display: none; z-index: 1000; }
    .dark-mode #notifications { background: #2e7d32; color: #fff; }
    .hidden { display: none; }
    .balance { font-size: 28px; color: #4caf50; font-weight: bold; }
    .transaction { margin: 10px 0; padding: 15px; border-bottom: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
    .dark-mode .transaction { background: #2a2a2a; border-color: #444; }
    .chart-container { width: 100%; height: 300px; margin: 20px 0; }
    .qr-code { text-align: center; margin: 20px 0; }
    .toggle { position: fixed; top: 10px; left: 10px; }
    .chat-history { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
    .dark-mode .chat-history { border-color: #555; background: #333; }
    @media (max-width: 768px) { .section { padding: 15px; } input, textarea { width: 100%; } #notifications { width: 90%; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="toggle">
      <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
    </div>
    <h1>PiX Pay Dashboard</h1>
    <div id="notifications"></div>

    <!-- Auth Section -->
    <div id="auth" class="section">
      <h2>Authentication</h2>
      <button onclick="loginWithX()">Login with X (Twitter)</button>
      <form id="registerForm" class="hidden">
        <input type="text" id="username" placeholder="Username" required>
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit">Register</button>
      </form>
      <form id="loginForm" class="hidden">
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <input type="text" id="twoFactorToken" placeholder="2FA Token (if enabled)">
        <button type="submit">Login</button>
      </form>
      <button onclick="toggleForms()">Switch to Manual Auth</button>
    </div>

    <!-- Dashboard (Hidden until logged in) -->
    <div id="dashboard" class="section hidden">
      <h2>Welcome, <span id="userName"></span></h2>
      <div class="balance">Pi Balance: <span id="balance">0</span></div>
      <button onclick="minePi()">Mine Pi</button>
      <button onclick="getAIReport()">Get AI Report</button>
      <button onclick="predictTrends()">Predict Trends</button>
      <div id="adminPanel" class="hidden">
        <h3>Admin Panel</h3>
        <button onclick="viewUsers()">View Users</button>
        <button onclick="bulkTip()">Bulk Tip</button>
      </div>
    </div>

    <!-- Charts Section -->
    <div id="charts" class="section hidden">
      <h2>Analytics Charts</h2>
      <div class="chart-container">
        <canvas id="balanceChart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="transactionChart"></canvas>
      </div>
    </div>

    <!-- 2FA Setup -->
    <div id="2fa" class="section hidden">
      <h2>Setup 2FA</h2>
      <button onclick="setup2FA()">Setup 2FA</button>
      <div id="qrCode" class="qr-code"></div>
    </div>

    <!-- Wallet Linking -->
    <div id="wallet" class="section hidden">
      <h2>Link Wallets</h2>
      <input type="text" id="piUserId" placeholder="Pi User ID" required>
      <input type="text" id="xUserId" placeholder="X User ID" required>
      <button onclick="linkWallets()">Link Accounts</button>
    </div>

    <!-- Payments -->
    <div id="payments" class="section hidden">
      <h2>Send Tip</h2>
      <input type="text" id="toUserId" placeholder="Recipient User ID" required>
      <input type="number" id="amount" placeholder="Amount (Pi)" step="0.01" required>
      <input type="text" id="tweetId" placeholder="Tweet ID (optional)">
      <button onclick="getSuggestion()">AI Suggest Amount</button>
      <span id="suggestion"></span>
      <button onclick="sendTip()">Send Tip</button>
      <h3>Transaction History</h3>
      <div id="history"></div>
    </div>

    <!-- AI Features Section -->
    <div id="ai-features" class="section hidden">
      <h2>Super-Advanced AI Features</h2>
      <div>
        <h3>Sentiment Analysis</h3>
        <textarea id="sentimentText" placeholder="Enter text (e.g., tweet content) for sentiment analysis" rows="3"></textarea>
        <button onclick="analyzeSentiment()">Analyze Sentiment</button>
        <div id="sentimentResult"></div>
      </div>
      <div>
        <h3>AI Chatbot</h3>
        <div id="chatHistory" class="chat-history"></div>
        <input type="text" id="chatMessage" placeholder="Ask the AI anything about PiX Pay">
        <button onclick="sendChat()">Send</button>
        <button onclick="clearChat()">Clear Chat</button>
      </div>
      <div>
        <h3>Market Trend Prediction</h3>
        <button onclick="getMarketTrend()">Predict Pi Market Trend</button>
        <div id="marketTrend"></div>
      </div>
      <div>
        <h3>Dynamic Pricing</h3>
        <input type="number" id="engagement" placeholder="Engagement Score (0-1000)" step="1">
        <input type="number" id="timeOfDay" placeholder="Time of Day (0-23)" step="1">
        <input type="number" id="demand" placeholder="Demand Level (0-1)" step="0.1">
        <button onclick="getDynamicPrice()">Calculate Dynamic Price</button>
        <div id="dynamicPrice"></div>
      </div>
    </div>

    <!-- Pi Regulation Dashboard -->
    <div id="pi-regulation" class="section hidden">
      <h2>Pi Coin Regulation Dashboard</h2>
      <p>Autonomous AI regulates Pi as a stablecoin at 1 PI = $314,159 for mined, reward, and P2P origins only. Exchanges and unclear sources are rejected.</p>
      <button onclick="getInsights()">Get AI Insights</button>
      <div id="insights"></div>
      <button onclick="startMonitoring()">Start Real-Time Monitoring</button>
      <div id="monitoringStatus">Monitoring: Off</div>
      <div id="adminControls" class="hidden">
        <input type="text" id="flagHash" placeholder="Hash to flag/unflag">
        <button onclick="flagSource(true)">Flag Source</button>
        <button onclick="flagSource(false)">Unflag Source</button>
      </div>
    </div>

    <!-- Pi Verification Section -->
    <div id="pi-verification" class="section hidden">
      <h2>Pi Coin Verification & Stablecoin Regulation</h2>
      <p>Pi Coin (PI) is regulated as a stablecoin at a fixed value of $314,159 for mined, reward, and P2P origins only.</p>
      <input type="text" id="piId" placeholder="Pi Coin ID" required>
      <select id="origin">
        <option value="mined">Mined</option>
        <option value="reward">Reward</option>
        <option value="p2p">P2P</option>
        <option value="exchange">Exchange (will be rejected)</option>
      </select>
      <button onclick="verifyPi()">Verify Pi Coin</button>
      <div id="verificationResult"></div>
      <button onclick="getStableValue()">Get Stable Value</button>
      <div id="stableValue"></div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.0/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const socket = io('http://localhost:3000');
    let token = localStorage.getItem('token');
    let userId;
    let isAdmin = false;

    // DOM Elements
    const body = document.body;
    const authDiv = document.getElementById('auth');
    const dashboardDiv = document.getElementById('dashboard');
    const chartsDiv = document.getElementById('charts');
    const twoFADiv = document.getElementById('2fa');
    const walletDiv = document.getElementById('wallet');
    const paymentsDiv = document.getElementById('payments');
    const aiFeaturesDiv = document.getElementById('ai-features');
    const piRegulationDiv = document.getElementById('pi-regulation');
    const piVerificationDiv = document.getElementById('pi-verification');
    const notifications = document.getElementById('notifications');
    const balanceSpan = document.getElementById('balance');
    const userNameSpan = document.getElementById('userName');
    const historyDiv = document.getElementById('history');
    const suggestionSpan = document.getElementById('suggestion');
    const adminPanel = document.getElementById('adminPanel');

    // PWA Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(() => console.log('SW registered'));
    }

    // Dark Mode
    function toggleDarkMode() {
      body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', body.classList.contains('dark-mode'));
    }
    if (localStorage.getItem('darkMode') === 'true') body.classList.add('dark-mode');

    // Initialize
    if (token) {
      showDashboard();
      loadUserData();
      loadCharts();
    }

    // Auth Functions
    function loginWithX() {
      window.location.href = 'http://localhost:3000/auth/x';
    }

    function toggleForms() {
      document.getElementById('registerForm').classList.toggle('hidden');
      document.getElementById('loginForm').classList.toggle('hidden');
    }

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const res = await fetch('/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: document.getElementById('username').value,
          email: document.getElementById('email').value,
          password: document.getElementById('password').value
        })
      });
      const data = await res.json();
      if (res.ok) {
        showNotification('Registered successfully! Please login.');
        toggleForms();
      } else {
        showNotification(data.error, 'error');
      }
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const headers = { 'Content-Type': 'application/json' };
      const tokenField = document.getElementById('twoFactorToken').value;
      if (tokenField) headers['x-2fa-token'] = tokenField;
      const res = await fetch('/auth/login', {
        method: 'POST',
        headers,
        body: JSON.stringify({
          email: document.getElementById('loginEmail').value,
          password: document.getElementById('loginPassword').value
        })
      });
      const data = await res.json();
      if (res.ok) {
        token = data.token;
        localStorage.setItem('token', token);
        userId = data.user.id;
        isAdmin = data.user.username === 'admin';
        showDashboard();
        loadUserData();
        loadCharts();
      } else {
        showNotification(data.error, 'error');
      }
    });

    // Dashboard Functions
    function showDashboard() {
      authDiv.classList.add('hidden');
      dashboardDiv.classList.remove('hidden');
      chartsDiv.classList.remove('hidden');
      twoFADiv.classList.remove('hidden');
      walletDiv.classList.remove('hidden');
      paymentsDiv.classList.remove('hidden');
      aiFeaturesDiv.classList.remove('hidden');
      piRegulationDiv.classList.remove('hidden');
      piVerificationDiv.classList.remove('hidden');
      if (isAdmin) {
        adminPanel.classList.remove('hidden');
        document.getElementById('adminControls').classList.remove('hidden');
      }
      socket.emit('join', userId);
    }

    async function loadUserData() {
      const res = await fetch('/wallet/balance', { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();
      if (res.ok) {
        balanceSpan.textContent = data.balance;
        userNameSpan.textContent = 'User';
      }
    }

    async function minePi() {
      const res = await fetch('/wallet/mine', { method: 'POST', headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();
      if (res.ok) {
        showNotification(`Mined ${data.reward} Pi!`);
        loadUserData();
        loadCharts();
      } else {
        showNotification(data.error, 'error');
      }
    }

    async function getAIReport() {
      const res = await fetch('/payments/report', { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();
      if (res.ok) {
        showNotification(data.report);
      } else {
        showNotification(data.error, 'error');
      }
    }

    async function predictTrends() {
      const res = await fetch('/ai/predict', { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();
      if (res.ok) {
        showNotification(`Predicted next tip: ${data.prediction} Pi`);
      } else {
        showNotification('Prediction failed', 'error');
      }
    }

    // Charts
    async function loadCharts() {
      const balanceRes = await fetch('/analytics/balance-history', { headers: { Authorization: `Bearer ${token}` } });
      const balanceData = await balanceRes.json();
      new Chart(document.getElementById('balanceChart'), {
        type: 'line',
        data: { labels: balanceData.labels || ['Day1', 'Day2', 'Day3'], datasets: [{ label: 'Pi Balance', data: balanceData.values || [0.1, 0.2, 0.15], borderColor: '#1da1f2' }] }
      });

      const txRes = await fetch('/analytics/transactions', { headers: { Authorization: `Bearer ${token}` } });
      const txData = await txRes.json();
      new Chart(document.getElementById('transactionChart'), {
        type: 'bar',
        data: { labels: txData.labels || ['Tx1', 'Tx2', 'Tx3'], datasets: [{ label
